name: CI/CD Local (testapp)

'on':
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: testapp-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-push-update:
    env:
      ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      DOCKER_CONFIG: ${{ github.workspace }}/.docker
      BASE_IMAGE: registry-cache.default.svc.cluster.local:5000/library/node:22.20.0-alpine
      BUILDKIT_IMAGE: registry-cache.default.svc.cluster.local:5000/moby/buildkit:v0.26.2
    timeout-minutes: 45
    runs-on:
      - self-hosted
      - linux
      - k3d

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout manifests repo
        uses: actions/checkout@v4
        with:
          repository: rafaelmfried/testapp-manifests
          path: testapp-manifests
          token: ${{ secrets.MANIFESTS_REPO_TOKEN }}

      - name: Install Docker Buildx
        run: |
          PLUGIN_DIR="${DOCKER_CONFIG}/cli-plugins"
          mkdir -p "$PLUGIN_DIR"
          if ! docker buildx version >/dev/null 2>&1; then
            ARCH="$(uname -m)"
            case "$ARCH" in
              x86_64) ARCH="amd64" ;;
              aarch64|arm64) ARCH="arm64" ;;
              *) echo "Arquitetura nao suportada: $ARCH"; exit 1 ;;
            esac
            curl -sSL -o "$PLUGIN_DIR/docker-buildx" \
              "https://github.com/docker/buildx/releases/download/v0.12.1/buildx-v0.12.1.linux-${ARCH}"
            chmod +x "$PLUGIN_DIR/docker-buildx"
          fi
          docker buildx version

      - name: Prepare Buildx config (insecure registry)
        run: |
          cat > buildkitd.toml <<'EOF'
          [registry."local-registry.default.svc.cluster.local:5000"]
            http = true
            insecure = true
          [registry."registry-cache.default.svc.cluster.local:5000"]
            http = true
            insecure = true
          EOF

      - name: Set up Docker Buildx
        run: |
          docker buildx rm localbuilder || true
          docker buildx create --name localbuilder --use --driver docker-container --driver-opt image="$BUILDKIT_IMAGE" --driver-opt network=host --config buildkitd.toml
          docker buildx inspect --bootstrap

      - name: Check npm registry access
        run: |
          curl -fsSLI --max-time 15 https://registry.npmjs.org/ >/dev/null
          curl -fsSLI --max-time 15 https://registry.npmjs.org/pnpm >/dev/null
          curl -fsSLI --max-time 15 https://registry.npmjs.org/@nestjs%2fcli >/dev/null

      - name: Build and push image (registry interno)
        run: |
          docker buildx build \
            --builder localbuilder \
            --platform linux/arm64 \
            --network host \
            --cache-from type=registry,ref=local-registry.default.svc.cluster.local:5000/testapp:buildcache \
            --cache-to type=registry,ref=local-registry.default.svc.cluster.local:5000/testapp:buildcache,mode=max \
            --build-arg BASE_IMAGE="$BASE_IMAGE" \
            -t local-registry.default.svc.cluster.local:5000/testapp:${{ github.sha }} \
            --push \
            -f docker/Dockerfile.testapp .

      - name: Update manifests (imagem usada pelo cluster)
        run: |
          sed -i "s|image: localhost:30000/testapp:.*|image: localhost:30000/testapp:${{ github.sha }}|" testapp-manifests/deployment.yaml
          sed -i "s|image: localhost:30000/testapp:.*|image: localhost:30000/testapp:${{ github.sha }}|" testapp-manifests/pod.yaml

      - name: Commit and push manifests
        run: |
          if git -C testapp-manifests diff --quiet -- deployment.yaml pod.yaml; then
            echo "No manifest changes to commit"
            exit 0
          fi
          git -C testapp-manifests config user.name "github-actions"
          git -C testapp-manifests config user.email "github-actions@users.noreply.github.com"
          git -C testapp-manifests add deployment.yaml pod.yaml
          git -C testapp-manifests commit -m "chore: update image to ${{ github.sha }}"
          git -C testapp-manifests push

      - name: Install ArgoCD CLI
        if: env.ARGOCD_AUTH_TOKEN != ''
        run: |
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64) ARCH="amd64" ;;
            aarch64|arm64) ARCH="arm64" ;;
            *) echo "Arquitetura nao suportada: $ARCH"; exit 1 ;;
          esac
          curl -sSL -o /tmp/argocd "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-${ARCH}"
          chmod +x /tmp/argocd
          echo "/tmp" >> "$GITHUB_PATH"

      - name: Sync ArgoCD
        if: env.ARGOCD_AUTH_TOKEN != ''
        run: |
          argocd login argocd-server.argocd.svc.cluster.local --auth-token "$ARGOCD_AUTH_TOKEN" --insecure
          argocd app sync testapp
