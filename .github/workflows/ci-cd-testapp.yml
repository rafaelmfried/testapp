name: CI/CD Local (testapp)

'on':
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-push-update:
    env:
      ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      DOCKER_CONFIG: ${{ github.workspace }}/.docker
    runs-on:
      - self-hosted
      - linux
      - k3d

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker Buildx
        run: |
          PLUGIN_DIR="${DOCKER_CONFIG}/cli-plugins"
          mkdir -p "$PLUGIN_DIR"
          if ! docker buildx version >/dev/null 2>&1; then
            ARCH="$(uname -m)"
            case "$ARCH" in
              x86_64) ARCH="amd64" ;;
              aarch64|arm64) ARCH="arm64" ;;
              *) echo "Arquitetura nao suportada: $ARCH"; exit 1 ;;
            esac
            curl -sSL -o "$PLUGIN_DIR/docker-buildx" \
              "https://github.com/docker/buildx/releases/download/v0.12.1/buildx-v0.12.1.linux-${ARCH}"
            chmod +x "$PLUGIN_DIR/docker-buildx"
          fi
          docker buildx version

      - name: Set up Docker Buildx
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap

      - name: Build and push image (registry interno)
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --cache-from type=registry,ref=local-registry.default.svc.cluster.local:5000/testapp:buildcache \
            --cache-to type=registry,ref=local-registry.default.svc.cluster.local:5000/testapp:buildcache,mode=max \
            -t local-registry.default.svc.cluster.local:5000/testapp:${{ github.sha }} \
            --push \
            -f docker/Dockerfile.testapp .

      - name: Update manifests (imagem usada pelo cluster)
        run: |
          sed -i "s|image: localhost:30000/testapp:.*|image: localhost:30000/testapp:${{ github.sha }}|" testapp-manifests/deployment.yaml
          sed -i "s|image: localhost:30000/testapp:.*|image: localhost:30000/testapp:${{ github.sha }}|" testapp-manifests/pod.yaml

      - name: Commit and push manifests
        run: |
          if git diff --quiet -- testapp-manifests/deployment.yaml testapp-manifests/pod.yaml; then
            echo "No manifest changes to commit"
            exit 0
          fi
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add testapp-manifests/deployment.yaml testapp-manifests/pod.yaml
          git commit -m "chore: update image to ${{ github.sha }}"
          git push

      - name: Install ArgoCD CLI
        if: env.ARGOCD_AUTH_TOKEN != ''
        run: |
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64) ARCH="amd64" ;;
            aarch64|arm64) ARCH="arm64" ;;
            *) echo "Arquitetura nao suportada: $ARCH"; exit 1 ;;
          esac
          curl -sSL -o /tmp/argocd "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-${ARCH}"
          chmod +x /tmp/argocd
          echo "/tmp" >> "$GITHUB_PATH"

      - name: Sync ArgoCD
        if: env.ARGOCD_AUTH_TOKEN != ''
        run: |
          argocd login argocd-server.argocd.svc.cluster.local --auth-token "$ARGOCD_AUTH_TOKEN" --insecure
          argocd app sync testapp
